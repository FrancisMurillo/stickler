<!DOCTYPE html>
<html>
<head>
<title>Stickler</title>
<link href='css/jquery-ui-1.10.4.custom.min.css' rel='stylesheet' />
<link href='css/stickler.css' rel='stylesheet' />

<link href='lib/font-awesome-4.1.0/css/font-awesome.min.css' rel='stylesheet' />

<script src='js/jquery-2.1.1.min.js'></script>
<script src='js/jquery-ui-1.10.4.custom.min.js'></script>

<script src='js/jquery.topzindex.min.js'></script>
<script src='js/jquery.autosize.min.js'></script>
<script src="js/jquery.timeago.min.js"></script>
<script src="js/jquery.collapse.all.min.js"></script>
<script src="js/mustache.min.js"></script>

<script src='js/note.js'></script>

<!--  Custom Functions -->
<script>
	function uniqId() {
	  	return Math.round(new Date().getTime() + (Math.random() * 100));
	}
	/* Returns a number to a string with px on it. Eg toPx(300) = 300px */
	function toPx(unit) {
		return unit + 'px';
	}

</script>

<!-- Main Logic -->
<script type='text/javascript'>
		$(document).ready(function() {
			var NOTE_WIDTH = 200;
			var NOTE_HEIGHT = 250;
		
			$('#add-note').on('click.add' , function() {
				createNewNote(NOTE_WIDTH , NOTE_HEIGHT, $('#note_area') ,'note-task');
			});
			
			$('#save-notes').on('click.save' , function() {
				var notes = [];
				$('.note').each(function(idx , el) {
					var note = {};
					var $note = $(el);
					
					var id = $note.attr('id');
					var x = $note.position().left;
					var y = $note.position().top;
					var width = $note.width();
					var height = $note.height();

					note = {
							id		:	id		 , 
							x 		:	x	,
							y		:	y	,
							width	:	width	,
							height	:	height
						}
						
					var noteType = 'NA';
					if ($note.hasClass('note-task')) {
						noteType = 'note-task'
						
						var noteTitle = $note.find('.note-task-title').val();
						var noteResult = $note.find('.note-task-result').val();
						
						
					} 
					
					notes.push(note);
				});
				console.log(JSON.stringify(notes));
			});
			
			$('#sticky').draggable();
			$('#sticky').resizable({
				handle : 'n,s,e,w,ne,se,sw,nw' , 
				minWidth: 100 , 
				minHeight: 100 
			});
			$('#sticky').css({
					'width' 	: 	toPx(NOTE_WIDTH) 	, 
					'height'	: 	toPx(NOTE_HEIGHT)	,
					
					'zIndex'	:	$.topZIndex('.task-note') + 1	
				});
			$('.timeago').timeago();
				
			$('textarea').autosize({
				append: '' ,
				callback: function() {
					var $myNote = $(this).parents('.note-task');
					
					var getTotalHeight = function($arr) {
						var height = 0;
						$arr.each(function(index , elem) {
							height += $(elem).height();
						});
						return height;
					}
					
					var header = getTotalHeight($myNote.children('.note-header'));
					var body =  getTotalHeight($myNote.children('.note-body'));
					var footer = getTotalHeight($myNote.children('.note-footer'));

					$myNote.css({
						'height' : header + body + footer
					});
				}
			});		
			
			$('.note-task-subtask-add').on('click.add' , function(e) {
				var $section = $(this).closest('.note-task-subtask');
				var $list = $section.find('.subtask-list');
				
				var view = "<li class='subtask'> \
								<div class='subtask-content' >\
									<input type='checkbox'/>\
									<textarea placeholder='<Your subtask>'></textarea>\
									</div>\
								<div class='timeago' title='{{time_created}}' />\
							</li>";
				var data  = {
					time_created : new Date().toISOString()
				};
				var $task = $(Mustache.render(view , data));
				
				$task.find('.timeago').timeago();
				$task.find('textarea').resize({
					append: '' 
				});
				
				$list.append($task);
			});
		
		});
	</script>
</head>
<body>
	<div id='wrapper'>
		<div id='action-area'>
			<section id='action-area-types'>
				<a id='all-filter' class='task-filter-leftmost' href='#'>All</a> <a
					id='task-filter' href='#'>Tasks</a> <a id='issue-filter'
					class='task-filter-rightmost' href='#'>Issues</a>
			</section>

			<a id='add-note' href='#'><i class='fa fa-plus fa-2x'></i></a>
			<a id='save-notes' href='#'><i class='fa fa-floppy-o fa-2x'></i></a>
		</div>
		<div id='note_area'>
			<div id='sticky' class='note note-task' title='June 17 , 2014'>
				<header class='note-header note-task-header'>
					<a	class='note-header-cancel'><span class='ui-icon ui-icon-close'></span></a>
					<span class='timeago' title='June 17 , 2014'></span>
				</header>
				<section class='note-body note-main note-task-main'>
					<textarea class='note-task-title' placeholder='<Your Note Title>'></textarea>
					<textarea class='note-task-result' placeholder='<Your Task Result>'></textarea>
				</section>
				<section class='note-body note-task-subtask'>
					<header class='note-task-subtask-group'>
						<a class='note-task-subtask-add'><span class='ui-icon ui-icon-plus'></span></a>
						<span class='note-task-subtask-title'>Subtasks</span>
						<a class='note-task-subtask-collapse'><span class='ui-icon ui-icon-triangle-1-s'></span></a>	
						<a class='note-task-subtask-checked'><span class='ui-icon ui-icon-check'></span></a>
					</header>
					<section class='note-task-subtasks' data-collapse>
						<ul class='subtask-list'>
							<li class='subtask'>
								<div class='subtask-content' >
									<input type='checkbox'/>
									<textarea placeholder='<Your subtask>'></textarea>
								</div>
								<div class='timeago' title='June 17 , 2014' />
							</li>
						</ul>
					</section>
				</section>
				<footer class='note-footer'>
				</footer>
			</div>
		</div>
	</div>
</body>
</html>